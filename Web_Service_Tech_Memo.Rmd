---
title: "Oracle_test"
author: "Jordan Watson"
date: "5/30/2021"
output: html_document
---

```{r,include=F}
knitr::opts_chunk$set(warning=F,message=F)
```

```{r,include=F}
library(tidyverse)
library(DBI) #  For database query
library(odbc)
library(kableExtra)
library(sp) # For maps
library(rgdal) # For maps
library(broom)

#  Load the AKFIN database user name and password from an external file.
params <- read_csv("markdown_odbc_params.csv")

#  Connect to the AKFIN database
# con <- dbConnect(odbc::odbc(), "akfin", UID=rstudioapi::askForPassword("Enter AKFIN Username"), PWD= rstudioapi::askForPassword("Enter AFSC Password"))
con <- dbConnect(odbc::odbc(), "akfin", UID=params$uid, PWD=params$pass)
```


```{r}
#---------------------------------------------------------------------------------------
#  Make Strata Map
#---------------------------------------------------------------------------------------

#  Load an AK Basemap
akmap <- readOGR(dsn="Data",layer="AKbasemap")
#  Convert the object to a ggmap object
ak <- tidy(akmap) %>% 
  mutate(long2=ifelse(long<0,long+360,long))

xmin <- 165
xmax <- 230
ymin <- 50
ymax <- 68

#  Load the non-Crab areas
area<- readOGR(dsn="Data/Alaska_Marine_Management_Areas.gdb",layer="Alaska_Marine_Areas_dd")
test.df <- merge(fortify(area), as.data.frame(area), by.x="id", by.y=0) %>%
  mutate(long2=ifelse(long>0,long-360, long),
         BSIERP_ID=ifelse(BSIERP_ID==0,NA,BSIERP_ID)) %>% 
  rename(`NMFS Area`=NMFS_REP_AREA,`ESR Region`=Ecosystem_Subarea,`ADFG Stat Area`=STAT_AREA,`BSIERP Region`=BSIERP_ID)

#  Load and merge the two different crab shapefiles.
crab <- readOGR(dsn="../../Other_People/Erin_Fedewa/Data",layer="BristolBay") %>% 
  fortify() %>% 
  mutate(long2=ifelse(long<0,long+360, long),
         group="bb") %>% 
  bind_rows(readOGR(dsn="../../Other_People/Erin_Fedewa/Data",layer="St_Matthew_District") %>% 
              fortify() %>% 
              mutate(long2=ifelse(long<0,long+360,long)
                     group="stm"))

#  Merge the different polygon fields and shapefiles.
newdata <- test.df %>% 
  filter(!is.na(`NMFS Area`)) %>% 
  mutate(stratum="NMFS Areas") %>% 
  bind_rows(test.df %>% 
              filter(!is.na(`BSIERP Region`)) %>% 
              mutate(stratum="BSIERP Regions")) %>% 
  bind_rows(test.df %>% 
              filter(!is.na(`ESR Region`)) %>% 
              mutate(stratum="ESR Regions")) %>% 
  bind_rows(test.df %>% 
              filter(!is.na(`ADFG Stat Area`)) %>% 
              mutate(stratum="ADFG Stat Areas")) %>% 
  bind_rows(crab %>% 
              mutate(stratum="Crab Mgmt Areas"))
  
ggplot() + 
  geom_polygon(data=ak,aes(x=long2,y=lat,group=factor(group)),fill="grey70") +
  geom_polygon(data=newdata,aes(long2,lat,group=factor(group)),fill=NA,color="black") + 
  facet_wrap(~stratum,ncol=2) +
  coord_map("albers",lat0=54,lat1=62,xlim=c(xmin,xmax),ylim=c(ymin,ymax)) + 
  theme_void()
```





**Oracle database queries**

Some data users prefer the flexibility and transparency of querying raw gridded data directly from the Oracle server. This is particularly useful for larger queries (e..g, millions of records) or for exploring data across a suite of different spatial extents (e.g., custom depth ranges, shapefiles, etc.). As we note in the web services section, such custom queries can also be automated by working with AFSC and AKFIN staff. However, for users that prefer to code their own queries, we provide several examples here. Notably, to query directly from the database, users will need an AKFIN database account, which can be provided by contacting the authors of this document.  

This section is not meant to serve as a SQL tutorial. Rather, its purpose is to orient users to the structure of the database related to the SST data and lookup tables. We assume that users interested in querying the database directly via Oracle (e.g., SQL Developer) or through odbc connections from R or Python are already acquainted with the coding and configuration settings. However, interested users can contact the authors for assistance establishing such connections or custom SQL queries.  

The gridded SST data (Fig. BB) are stored within the AFSC schema on the AKFIN Oracle database and the primary key linking the lookup tables (Fig. AA) with the gridded data is the ID field. In the lookup table, it is simply “ID” and in the data table it is “CRW_ID”. 


```{sql, connection=con,output.var="data"}
      select * from  afsc.erddap_crw_sst_spatial_lookup 
      where rownum<=5
```

```{r,echo=F}
data %>% 
  kbl(digits=2,
      format.args = list(big.mark = ',')) %>%
  kable_styling(fixed_thead = TRUE,
                font_size = 10)
```
Figure BB. Screenshot of the AFSC.ERDDAP_CRW_SST table.

```{sql, connection=con,output.var="data"}
      select * from  afsc.erddap_crw_sst 
      where rownum<=5
```

```{r,echo=F}
data %>% 
  kbl(digits=2,
      format.args = list(big.mark = ',')) %>%
  kable_styling(fixed_thead = TRUE,
                font_size = 10)
```
Figure AA. Screenshot of a CRW SST query within SQL Developer. Several columns reveal ‘NA’ because the particular latitude - longitude coordinates shown do not fall within any spatial strata represented by those columns.    

The following query demonstrates the primary key relationship between the data and lookup tables. In this case, we query SST (“TEMP”) data that fall within a crab management area and we add a field for “Year” (Fig. CC).

```{sql, connection=con,output.var="data"}
select read_date,
       temp,
       to_char(read_date,'YYYY') as Year,
       crab
from   afsc.erddap_crw_sst a
       INNER JOIN (select * from afsc.erddap_crw_sst_spatial_lookup
                   where crab <> 'NA') b
         ON a.crw_id =b.id
where rownum<=5
```


```{r,echo=F}
data %>%
  kbl(digits=2,
      format.args = list(big.mark = ',')) %>%
  kable_styling(fixed_thead = TRUE,
                font_size = 10)
```
Figure CC. Screenshot of a CRW SST query for records that fall within a crab management area. 

```{r Query_CRW_Crab_plot}
dbFetch(dbSendQuery(con,
                    paste0("select read_date,
                                   round(avg(temp),2) as sst,
                                   crab
                            from afsc.erddap_crw_sst a
                            INNER JOIN (select * 
                                      from afsc.erddap_crw_sst_spatial_lookup
                                      where crab = 'bb') b
                            ON a.crw_id = b.id 
                            group by 
                               crab,
                               read_date"))) %>% 
  ggplot(aes(READ_DATE,SST)) + 
  geom_line() + 
  geom_smooth()
```

Figure DD. Screenshot of a plotted query of Bristol Bay crab management area SST data averaged daily and plotted with default smoothing.
